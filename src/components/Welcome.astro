---
import '../style/welcome.css';
---
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GLLR - Sistema de Gesti√≥n de Notas</title>
    <!-- Incluye Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Incluye Boxicons para √≠conos -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <!-- Enlaza tu archivo CSS personalizado -->
    <link rel="stylesheet" href="/style/welcome.css">
    <!-- Fonts - Inter y otras que se usan en tu CSS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
</head>
<body>

    <!-- Contenido principal de la p√°gina -->
    <section class="welcome-contents">
        <!-- Elementos decorativos (elipses) -->
        <img src="/public/SVG/EllipseFigma.svg" class="welcome-elipce-1 welcome-elipce" alt="Elipse decorativa">
        <img src="/public/SVG/EllipseFigma.svg" class="welcome-elipce-2 welcome-elipce" alt="Elipse decorativa">

        <!-- Barra de navegaci√≥n (Header) -->
        <header class="navbar-gllr">
            <div class="container align-items-center">
                <div class="navbar-logo">
                    <img src="/public/SVG/Logo-1.svg" alt="GLLR Logo">
                </div>
                <div class="navbar-buttons">
                    <!-- Botones de navegaci√≥n con nuevas clases para el degradado -->
                    <button class="btn btn-nav-gradient-primary" data-bs-toggle="modal" data-bs-target="#loginModal">Ingresar <i class='bx bx-right-arrow-alt'></i></button>
                    <!-- El bot√≥n de registro ahora abre el registerModal (el nuevo formulario principal) -->
                    <button class="btn btn-nav-gradient-secondary" data-bs-toggle="modal" data-bs-target="#registerModal">Registrarse <i class='bx bx-right-arrow-alt'></i></button>
                </div>
            </div>
        </header>

        <!-- Contenido principal de la bienvenida (Hero Section) -->
        <div class="welcome-content-info">
            <div class="welcome-content-text">
                <h1 class="welcome-title">¬°Bienvenido/a a GLLR!</h1>
                <p class="welcome-content-sub-paragraph">
                    Con GLLR, lleva un control detallado de tus calificaciones, organiza tus tareas y gestiona tus objetivos acad√©micos de forma sencilla y eficiente.
                </p>
            </div>
        </div>
        <!-- Imagen de fondo que se fusiona con el contenido -->
        <div class="welcome-background-image"></div>
    </section>

    <!-- Pie de p√°gina (Footer) -->
    <footer class="footer-gllr">
        <div class="container text-center">
            <div class="footer-logo">
                <img src="/public/SVG/Logo-1.svg" alt="GLLR Logo">
            </div>
            <div class="footer-social-icons">
                <a href="#"><i class='bx bxl-facebook-square'></i></a>
                <a href="#"><i class='bx bxl-instagram'></i></a>
                <a href="#"><i class='bx bxl-linkedin-square'></i></a>
            </div>
            <p class="footer-copyright">&copy; 2025 Todos los derechos reservados</p>
        </div>
    </footer>

    <!-- Modal LOGIN -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    <img class="logo-login" src="/public/SVG/Logo-1.svg" alt="GLLR Logo">
                    <h5 class="modal-title" id="loginModalLabel">Bienvenido De Nuevo üëã</h5>
                    <p class="login-modal-p">Inicia sesi√≥n para empezar la revisi√≥n de tus notas.</p>
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="email" class="form-label">Correo Electr√≥nico</label>
                            <input type="email" class="form-control" id="email" required />
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Contrase√±a</label>
                            <input type="password" class="form-control" id="password" required />
                        </div>
                        <!-- Bot√≥n del modal de login con la clase personalizada -->
                        <button type="submit" class="btn btn-primary-custom w-100">Iniciar Sesi√≥n</button>
                    </form>
                    <div class="text-center mt-3">
                        <!-- El bot√≥n de "Reg√≠strate aqu√≠" ahora abre el registerModal -->
                        <button class="btn btn-link" data-bs-toggle="modal" data-bs-target="#registerModal" data-bs-dismiss="modal">
                            ¬øNo tienes cuenta? Reg√≠strate aqu√≠
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Nuevo Modal: Registro (registerModal) - ESTE ES EL FORMULARIO DE REGISTRO PRINCIPAL -->
    <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg"> <!-- Cambiado a modal-lg para m√°s espacio -->
        <div class="modal-content">
          <div class="modal-body">
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            <img class="logo-login" src="/public/SVG/Logo-1.svg" alt="GLLR Logo"> <!-- Logo dentro del modal como en la imagen -->
            <h5 class="modal-title" id="registerModalLabel">Registro</h5> <!-- T√≠tulo "Registro" como en la imagen -->
            <p class="login-modal-p">Crea tu cuenta para acceder al sistema.</p>

            <form id="formRegistroPrincipal"> <!-- Nuevo ID para el formulario principal de registro -->
              <!-- üîπ Informaci√≥n Personal -->
              <h6 class="section-title">Informaci√≥n Personal</h6>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="regCedula" class="form-label">C√©dula <span class="campo-obligatorio">*</span></label>
                  <input type="text" class="form-control" id="regCedula" placeholder="Ejemplo: 12345678" required />
                  <div class="invalid-feedback"></div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="regPrimerNombre" class="form-label">Primer Nombre <span class="campo-obligatorio">*</span></label>
                  <input type="text" class="form-control" id="regPrimerNombre" placeholder="Tu Primer Nombre" required />
                  <div class="invalid-feedback"></div>
                </div>
              </div>
    
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="regSegundoNombre" class="form-label">Segundo Nombre</label>
                  <input type="text" class="form-control" id="regSegundoNombre" placeholder="Tu Segundo Nombre" />
                  <div class="invalid-feedback"></div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="regPrimerApellido" class="form-label">Primer Apellido <span class="campo-obligatorio">*</span></label>
                  <input type="text" class="form-control" id="regPrimerApellido" placeholder="Tu Primer Apellido" required />
                  <div class="invalid-feedback"></div>
                </div>
              </div>
    
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="regSegundoApellido" class="form-label">Segundo Apellido</label>
                  <input type="text" class="form-control" id="regSegundoApellido" placeholder="Tu Segundo Apellido" />
                  <div class="invalid-feedback"></div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="regEmail" class="form-label">Correo Electr√≥nico <span class="campo-obligatorio">*</span></label>
                  <input type="email" class="form-control" id="regEmail" placeholder="ejemplo.venezuela@gmail.com" required />
                  <div class="invalid-feedback"></div>
                </div>
              </div>

              <!-- üîπ Tel√©fono -->
              <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="regTelefono" class="form-label">Tel√©fono <span class="campo-obligatorio">*</span></label>
                    <div class="d-flex align-items-center gap-2">
                      <select class="form-select codigo-area" id="regCodigoArea" style="width: 80px;" required>
                        <option value="0412">0412</option>
                        <option value="0422">0422</option>
                        <option value="0424">0424</option>
                        <option value="0414">0414</option>
                        <option value="0416">0416</option>
                        <option value="0426">0426</option>
                      </select>
                      <span class="separador-telefono">-</span>
                      <input 
                        type="tel" 
                        class="form-control numero-telefono" 
                        id="regNumeroTelefono"
                        placeholder="1234567" 
                        pattern="[0-9]{7}" 
                        title="Debe contener 7 d√≠gitos" 
                        required
                        style="flex-grow: 1;"
                      >
                      <div class="invalid-feedback"></div>
                    </div>
                  </div>
              </div>
    
              <!-- üîπ Ubicaci√≥n -->
              <h6 class="section-title mt-4">Ubicaci√≥n</h6>
              <div class="row">
                <div class="col-md-12 mb-3">
                  <label for="regDireccion" class="form-label">Direcci√≥n <span class="campo-obligatorio">*</span></label>
                  <input type="text" class="form-control" id="regDireccion" placeholder="Ingrese su direcci√≥n" required />
                  <div class="invalid-feedback"></div>
                </div>
              </div>
    
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="regEstado" class="form-label">Estado <span class="campo-obligatorio">*</span></label>
                  <select class="form-select" id="regEstado" required>
                       <option value="" selected disabled>Seleccione un estado</option>
                  </select>
                  <div class="invalid-feedback"></div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="regCiudad" class="form-label">Ciudad <span class="campo-obligatorio">*</span></label>
                  <select class="form-select" id="regCiudad" required disabled>
                    <option value="" selected disabled>Primero seleccione un estado</option>
                  </select>
                  <div class="invalid-feedback"></div>
                </div>
              </div>
    
              <!-- üîπ Credenciales de Acceso -->
              <h6 class="section-title mt-4">Credenciales de Acceso</h6>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="regPassword" class="form-label">Contrase√±a <span class="campo-obligatorio">*</span></label>
                  <div class="input-group">
                    <input type="password" class="form-control" id="regPassword" placeholder="Tu Contrase√±a" required />
                    <button class="btn btn-outline-secondary toggle-password" type="button" data-target="regPassword">
                        <i class='bx bx-hide'></i>
                    </button>
                    <div class="invalid-feedback"></div>
                  </div>
                  <small id="passwordStrength" class="form-text text-muted"></small>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="regConfirmPassword" class="form-label">Confirmar contrase√±a <span class="campo-obligatorio">*</span></label>
                  <div class="input-group">
                    <input type="password" class="form-control" id="regConfirmPassword" placeholder="Confirma tu Contrase√±a" required />
                    <button class="btn btn-outline-secondary toggle-password" type="button" data-target="regConfirmPassword">
                        <i class='bx bx-hide'></i>
                    </button>
                    <div class="invalid-feedback"></div>
                  </div>
                </div>
              </div>
    
              <!-- üîπ Botones -->
              <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-secondary-custom" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary-custom" id="submitNewRegisterForm">Registrarse</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Incluye Bootstrap JS (con Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <!-- Tu script JS para la l√≥gica de los modales y el backend -->
    <script type="module">
        // Variables globales (ajustadas para el nuevo flujo)
        const loginForm = document.getElementById('loginForm');
        const formRegistroPrincipal = document.getElementById('formRegistroPrincipal'); // Nuevo ID para el formulario principal de registro

        // Elementos del nuevo formulario de registro
        const regCedulaInput = document.getElementById('regCedula');
        const regPrimerNombreInput = document.getElementById('regPrimerNombre');
        const regSegundoNombreInput = document.getElementById('regSegundoNombre');
        const regPrimerApellidoInput = document.getElementById('regPrimerApellido');
        const regSegundoApellidoInput = document.getElementById('regSegundoApellido');
        const regEmailInput = document.getElementById('regEmail');
        const regDireccionInput = document.getElementById('regDireccion');
        // Eliminado: const regUsuarioInput = document.getElementById('regUsuario');
        const regPasswordInput = document.getElementById('regPassword');
        const regConfirmPasswordInput = document.getElementById('regConfirmPassword');

        const regCodigoAreaSelect = document.getElementById('regCodigoArea');
        const regNumeroTelefonoInput = document.getElementById('regNumeroTelefono');
        const regEstadoSelect = document.getElementById('regEstado');
        const regCiudadSelect = document.getElementById('regCiudad');
        const submitNewRegisterFormBtn = document.getElementById('submitNewRegisterForm');
        const passwordStrengthFeedback = document.getElementById('passwordStrength');


        // üõ† Verificar sesi√≥n antes de acceder al dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('http://localhost:3001/usuario', {
                    method: 'GET',
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.id && (window.location.pathname === "/" || window.location.pathname === "/welcome")) {
                    window.location.href = data.rol === 'admin' ? "/Admin-Control/Admin-home" : "/Students/Students-Control" || data.rol === 'pendiente' ? "/" : "/welcome";
                }
                } catch (error) {
                console.error('‚ùå Error verificando sesi√≥n:', error);
            }
        });

        // L√≥gica de inicio de sesi√≥n
        loginForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const correoInput = document.getElementById('email');
            const contrasenaInput = document.getElementById('password');

            if (!correoInput || !contrasenaInput) {
                console.error('‚ùå Error: No se encontraron los campos de correo o contrase√±a.');
                showCustomAlert('Error: No se encontraron los campos de correo o contrase√±a.');
                return;
            }

            const correo = correoInput.value.trim();
            const contrasena = contrasenaInput.value.trim();

            if (!correo || !contrasena) {
                showCustomAlert('Todos los campos son obligatorios.');
                return;
            }



            try {
                const response = await fetch('http://localhost:3001/login', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ correo, contrase√±a: contrasena })
                });

                const data = await response.json();
                

                if (response.ok) {
                    if (data.rol === 'pendiente') {
                        showCustomAlert('Tu cuenta est√° pendiente de aprobaci√≥n. Por favor, espera a que un administrador la apruebe.');
                    } else {
                    showCustomAlert('Inicio de sesi√≥n exitoso.', () => {
                        setTimeout(() => {
                            if (data.rol === 'admin') {
                                window.location.href = '/Admin-Control/Admin-home';
                            } else if (data.rol === 'estudiante') {
                                window.location.href = '/Students/Students-Control';
                            }
                        }, 200);    
                    });
                    }
                } else {
                    showCustomAlert(data.error);
                }
            } catch (error) {
                showCustomAlert('Error de conexi√≥n al servidor.');
                console.error(error);
            }
        });

        // L√≥gica del nuevo formulario de registro principal (registerModal)
        // Cargar datos al abrir el modal de registro
        document.getElementById('registerModal').addEventListener('shown.bs.modal', function() {
            cargarEstados();
            // Limpiar el formulario al abrirlo
            formRegistroPrincipal.reset();
            limpiarTodosLosErrores(formRegistroPrincipal);
            regCiudadSelect.innerHTML = '<option value="" selected disabled>Primero seleccione un estado</option>';
            regCiudadSelect.disabled = true;
            passwordStrengthFeedback.textContent = ''; // Limpiar mensaje de fortaleza de contrase√±a
        });

        // Funci√≥n para cargar estados
        async function cargarEstados() {
            regEstadoSelect.disabled = true;
            regEstadoSelect.innerHTML = '<option value="" selected disabled>Cargando estados...</option>';
            
            try {
                const response = await fetch('http://localhost:3001/api/estados');
                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                
                const estados = await response.json();
                
                regEstadoSelect.innerHTML = '<option value="" selected disabled>Seleccione un estado</option>';
                estados.forEach(estado => {
                    const option = document.createElement('option');
                    option.value = estado.id_estado;
                    option.textContent = estado.estados;
                    regEstadoSelect.appendChild(option);
                });
                
                regEstadoSelect.disabled = false;
            } catch (error) {
                console.error('Error cargando estados:', error);
                regEstadoSelect.innerHTML = '<option value="" selected disabled>Error al cargar estados</option>';
                showCustomAlert('Error al cargar estados. Intente recargar la p√°gina.');
            }
        }

        // Event listeners para los selects
        regEstadoSelect.addEventListener('change', async function() {
            const estadoId = this.value;
            regCiudadSelect.innerHTML = '<option value="" selected disabled>Cargando ciudades...</option>';
            regCiudadSelect.disabled = true;
            
            if (!estadoId) return;
            
            try {
                const response = await fetch(`http://localhost:3001/api/estados/${estadoId}/ciudades`);
                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                
                const ciudades = await response.json();
                
                regCiudadSelect.innerHTML = '<option value="" selected disabled>Seleccione una ciudad</option>';
                ciudades.forEach(ciudad => {
                    const option = document.createElement('option');
                    option.value = ciudad.id_ciudad;
                    option.textContent = ciudad.ciudad;
                    regCiudadSelect.appendChild(option);
                });
                
                regCiudadSelect.disabled = false;
            } catch (error) {
                console.error('Error cargando ciudades:', error);
                regCiudadSelect.innerHTML = '<option value="" selected disabled>Error al cargar ciudades</option>';
                showCustomAlert('Error al cargar ciudades. Intente nuevamente.');
            }
        });

        // Validar c√©dula al perder foco (regCedulaInput)
        regCedulaInput.addEventListener('blur', async function() {
            const cedula = this.value.trim();
            if (!cedula) {
                mostrarError(regCedulaInput, 'La c√©dula es obligatoria.');
                return;
            }
            // Validaci√≥n de formato de c√©dula venezolana (6 a 9 d√≠gitos num√©ricos)
            const cedulaRegex = /^\d{6,9}$/;
            if (!cedulaRegex.test(cedula)) {
                mostrarError(regCedulaInput, 'Formato de c√©dula inv√°lido (6-9 d√≠gitos num√©ricos).');
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:3001/api/verificar-cedula?cedula=${encodeURIComponent(cedula)}`);
                if (!response.ok) {
                    // Si la respuesta no es OK, podr√≠a ser un 409 Conflict o similar
                    const errorData = await response.json();
                    if (response.status === 409 && errorData.existe) { // Asumiendo que 409 indica conflicto de existencia
                        mostrarError(regCedulaInput, 'Esta c√©dula ya est√° registrada en el sistema.');
                        return; // Detener la ejecuci√≥n si la c√©dula ya existe
                    }
                    throw new Error(`Error HTTP: ${response.status} - ${errorData.message || 'Error desconocido'}`); 
                }
                
                const data = await response.json();
                if (data.existe) { // Asume que tu backend devuelve { existe: true/false }
                    mostrarError(regCedulaInput, 'Esta c√©dula ya est√° registrada en el sistema.');
                } else {
                    limpiarError(regCedulaInput);
                }
            } catch (error) {
                console.error('Error verificando c√©dula:', error);
                mostrarError(regCedulaInput, error.message || 'Error al verificar la c√©dula.');
            }
        });

        // Validar n√∫mero de tel√©fono
        regNumeroTelefonoInput.addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '').slice(0, 7);
            if (this.value.length !== 7) {
                mostrarError(this, 'Debe contener 7 d√≠gitos.');
            } else {
                limpiarError(this);
            }
        });

        // Toggle Password Visibility
        document.querySelectorAll('.toggle-password').forEach(button => {
            button.addEventListener('click', function() {
                const targetId = this.dataset.target;
                const passwordInput = document.getElementById(targetId);
                const icon = this.querySelector('i');

                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    icon.classList.remove('bx-hide');
                    icon.classList.add('bx-show');
                } else {
                    passwordInput.type = 'password';
                    icon.classList.remove('bx-show');
                    icon.classList.add('bx-hide');
                }
            });
        });

        // Password Strength Validation
        regPasswordInput.addEventListener('input', function() {
            const password = this.value;
            let strength = 0;
            let feedback = [];

            if (password.length >= 8) {
                strength += 1;
            } else {
                feedback.push('Al menos 8 caracteres.');
            }
            if (/[A-Z]/.test(password)) {
                strength += 1;
            } else {
                feedback.push('Una letra may√∫scula.');
            }
            if (/[a-z]/.test(password)) {
                strength += 1;
            } else {
                feedback.push('Una letra min√∫scula.');
            }
            if (/[0-9]/.test(password)) {
                strength += 1;
            } else {
                feedback.push('Un n√∫mero.');
            }
            if (/[^A-Za-z0-9]/.test(password)) {
                strength += 1;
            } else {
                feedback.push('Un caracter especial.');
            }

            if (password.length === 0) {
                passwordStrengthFeedback.textContent = '';
                limpiarError(regPasswordInput);
                return;
            }

            let strengthText = '';
            let color = '';

            if (strength === 5) {
                strengthText = '¬°Excelente!';
                color = 'green';
                limpiarError(regPasswordInput);
            } else if (strength >= 3) {
                strengthText = 'Buena';
                color = 'orange';
                limpiarError(regPasswordInput);
            } else {
                strengthText = 'D√©bil';
                color = 'red';
                mostrarError(regPasswordInput, 'Contrase√±a d√©bil: ' + feedback.join(', '));
            }
            passwordStrengthFeedback.textContent = `Fortaleza: ${strengthText}`;
            passwordStrengthFeedback.style.color = color;
        });

        // Validar coincidencia de contrase√±as
        regConfirmPasswordInput.addEventListener('input', function() { // Cambiado a 'input' para feedback m√°s r√°pido
            if (regPasswordInput.value !== regConfirmPasswordInput.value) {
                mostrarError(regConfirmPasswordInput, 'Las contrase√±as no coinciden.');
            } else {
                limpiarError(regConfirmPasswordInput);
            }
        });
        regPasswordInput.addEventListener('input', function() { // A√±adido para que se revalide al cambiar la primera
            if (regConfirmPasswordInput.value !== '') { // Solo revalida si ya hay algo en confirmar
                 if (regPasswordInput.value !== regConfirmPasswordInput.value) {
                    mostrarError(regConfirmPasswordInput, 'Las contrase√±as no coinciden.');
                } else {
                    limpiarError(regConfirmPasswordInput);
                }
            }
        });


        // Email Uniqueness Validation (Frontend with Backend API Call)
        regEmailInput.addEventListener('blur', async function() {
             const email = this.value.trim();
             if (!email) {
                 mostrarError(regEmailInput, 'El correo electr√≥nico es obligatorio.');
                 return;
             }

            try {
                const response = await fetch(`http://localhost:3001/api/verificar-correo?email=${encodeURIComponent(email)}`);
                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);

                const data = await response.json();

                if (data.existe) { 
                mostrarError(regEmailInput, 'Este correo electr√≥nico ya est√° registrado.');
                } else {
                limpiarError(regEmailInput);
                }
            } catch (error) {
                console.error('Error al verificar el correo electr√≥nico:', error);
                mostrarError(regEmailInput, 'Error al verificar el correo electr√≥nico. Intente de nuevo.');
            }
        });



        // L√≥gica para limpiar el formulario al hacer clic en "Cancelar"
        formRegistroPrincipal.querySelector('button[type="button"][data-bs-dismiss="modal"]').addEventListener('click', function() {
            formRegistroPrincipal.reset();
            limpiarTodosLosErrores(formRegistroPrincipal);
            regCiudadSelect.innerHTML = '<option value="" selected disabled>Primero seleccione un estado</option>';
            regCiudadSelect.disabled = true;
            passwordStrengthFeedback.textContent = ''; // Limpiar mensaje de fortaleza de contrase√±a
        });


        // Manejar env√≠o del formulario principal de registro
        formRegistroPrincipal.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validar campos obligatorios y reglas de contrase√±a
            const camposRequeridos = [
                { input: regCedulaInput, nombre: 'C√©dula' },
                { input: regPrimerNombreInput, nombre: 'Primer Nombre' },
                { input: regPrimerApellidoInput, nombre: 'Primer Apellido' },
                { input: regEmailInput, nombre: 'Correo Electr√≥nico' },
                { input: regDireccionInput, nombre: 'Direcci√≥n' },
                { input: regPasswordInput, nombre: 'Contrase√±a' },
                { input: regConfirmPasswordInput, nombre: 'Confirmar contrase√±a' },
                { input: regNumeroTelefonoInput, nombre: 'Tel√©fono' },
                { input: regEstadoSelect, nombre: 'Estado' },
                { input: regCiudadSelect, nombre: 'Ciudad' }
            ];

            let formularioValido = true;
            
            camposRequeridos.forEach(campo => {
                // Revalidar campos obligatorios
                if (!campo.input.value || (campo.input.tagName === 'SELECT' && campo.input.value === '')) {
                    mostrarError(campo.input, `El campo ${campo.nombre} es obligatorio.`);
                    formularioValido = false;
                } else {
                    limpiarError(campo.input);
                }
            });

            // Revalidaciones adicionales
            // Validaci√≥n de formato de c√©dula (6 a 9 d√≠gitos num√©ricos)
            const cedulaRegex = /^\d{6,9}$/;
            if (!cedulaRegex.test(regCedulaInput.value.trim())) {
                mostrarError(regCedulaInput, 'Formato de c√©dula inv√°lido (6-9 d√≠gitos num√©ricos).');
                formularioValido = false;
            }

            if (regPasswordInput.value !== regConfirmPasswordInput.value) {
                mostrarError(regConfirmPasswordInput, 'Las contrase√±as no coinciden.');
                formularioValido = false;
            }
            if (regNumeroTelefonoInput.value.length !== 7) {
                mostrarError(regNumeroTelefonoInput, 'El tel√©fono debe contener 7 d√≠gitos.');
                formularioValido = false;
            }
            // Forzar revalidaci√≥n de fortaleza de contrase√±a y email
            regPasswordInput.dispatchEvent(new Event('input')); 
            regEmailInput.dispatchEvent(new Event('blur')); 
            regCedulaInput.dispatchEvent(new Event('blur')); // Forzar revalidaci√≥n de c√©dula

            // Si hay alg√∫n error visible, el formulario no es v√°lido
            if (formRegistroPrincipal.querySelector('.is-invalid')) {
                formularioValido = false;
            }

            if (!formularioValido) {
                showCustomAlert('Por favor, complete todos los campos obligatorios y corrija los errores.');
                return;
            }

            // Mostrar loading en el bot√≥n
            submitNewRegisterFormBtn.disabled = true;
            submitNewRegisterFormBtn.innerHTML = `
              <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              Registrando...
            `;

            try {
                // Obtener valores del formulario
                const formData = {
                    cedula: regCedulaInput.value.trim(),
                    primerNombre: regPrimerNombreInput.value.trim(),
                    segundoNombre: regSegundoNombreInput.value.trim(),
                    primerApellido: regPrimerApellidoInput.value.trim(),
                    segundoApellido: regSegundoApellidoInput.value.trim(),
                    correo: regEmailInput.value.trim(), // Usar 'correo' para el backend
                    telefono: `${regCodigoAreaSelect.value}-${regNumeroTelefonoInput.value}`,
                    direccion: regDireccionInput.value.trim(),
                    id_estado: regEstadoSelect.value,
                    id_ciudad: regCiudadSelect.value,
                    contrase√±a: regPasswordInput.value.trim(), // Usar 'contrase√±a' para el backen
                };

                // Enviar datos al servidor
                const response = await fetch('http://localhost:3001/register', { // Ajusta el endpoint si es necesario
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error al registrar el usuario.');
                }

                // Mostrar mensaje de √©xito y redirigir o abrir modal de login
                showCustomAlert('Usuario registrado exitosamente. Ya puedes iniciar sesi√≥n.', () => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('registerModal'));
                    modal.hide();
                    new bootstrap.Modal(document.getElementById('loginModal')).show(); // Abrir modal de login
                });

            } catch (error) {
                console.error('Error en el registro:', error);
                showCustomAlert(error.message);
            } finally {
                // Restaurar bot√≥n
                submitNewRegisterFormBtn.disabled = false;
                submitNewRegisterFormBtn.textContent = 'Registrarse';
            }
        });

        // Funciones auxiliares para errores y alertas (adaptadas)
        function mostrarError(elemento, mensaje) {
            elemento.classList.add('is-invalid');
            // Busca el feedback de invalidez directamente despu√©s del elemento o dentro de su padre
            const errorElement = elemento.nextElementSibling; 
            if (errorElement && errorElement.classList.contains('invalid-feedback')) {
                errorElement.textContent = mensaje;
                errorElement.style.display = 'block';
            } else {
                const parentErrorElement = elemento.parentNode.querySelector('.invalid-feedback');
                if (parentErrorElement) {
                    parentErrorElement.textContent = mensaje;
                    parentErrorElement.style.display = 'block';
                }
            }
        }

        function limpiarError(elemento) {
            elemento.classList.remove('is-invalid');
            const errorElement = elemento.nextElementSibling;
            if (errorElement && errorElement.classList.contains('invalid-feedback')) {
                errorElement.textContent = '';
                errorElement.style.display = 'none';
            } else {
                const parentErrorElement = elemento.parentNode.querySelector('.invalid-feedback');
                if (parentErrorElement) {
                    parentErrorElement.textContent = '';
                    parentErrorElement.style.display = 'none';
                }
            }
        }

        function limpiarTodosLosErrores(form) {
            form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            form.querySelectorAll('.invalid-feedback').forEach(el => {
                el.textContent = '';
                el.style.display = 'none';
            });
        }
        
        function showCustomAlert(message, callback = () => {}) {
            const alertModalHtml = `
                <div class="modal fade" id="customAlertModal" tabindex="-1" aria-labelledby="customAlertModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content custom-alert-modal">
                            <div class="modal-body text-center">
                                <p class="mb-3">${message}</p>
                                <button type="button" class="btn btn-primary-custom" data-bs-dismiss="modal">Aceptar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Eliminar cualquier modal existente para evitar duplicados
            const existingModal = document.getElementById('customAlertModal');
            if (existingModal) {
                existingModal.remove();
            }

            document.body.insertAdjacentHTML('beforeend', alertModalHtml);
            const customAlertModal = new bootstrap.Modal(document.getElementById('customAlertModal'));
            customAlertModal.show();

            // Ejecutar callback cuando el modal se cierra
            document.getElementById('customAlertModal').addEventListener('hidden.bs.modal', callback);
        }
    </script>
</body>
</html>

