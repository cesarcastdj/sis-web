---
import "../style/welcome.css";
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GLLR - Sistema de Gesti√≥n de Notas</title>
    <!-- Incluye Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <!-- Incluye Boxicons para √≠conos -->
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <!-- Enlaza tu archivo CSS personalizado -->
    <link rel="stylesheet" href="/style/welcome.css" />
    <!-- Fonts - Inter y otras que se usan en tu CSS -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Playfair+Display:wght@700&display=swap"
      rel="stylesheet"
    />

    <!-- MODIFICACI√ìN: Estilos para select deshabilitado y otros inputs en tema oscuro -->
    <style>
      .form-select:disabled,
      .form-control:disabled {
        background-color: #2b2b2b !important; /* Color de fondo oscuro */
        color: #ffffff !important; /* Color de texto blanco */
        opacity: 0.8; /* Ligeramente menos opaco para indicar que est√° deshabilitado */
        border-color: #444444 !important; /* Borde m√°s oscuro */
      }
      /* Asegura que el color del placeholder tambi√©n sea visible en oscuro si el input est√° deshabilitado */
      .form-control:disabled::placeholder,
      .form-select:disabled option {
        color: #aaaaaa !important;
      }
      /* Asegura el color del texto de opci√≥n seleccionado en select deshabilitado */
      .form-select:disabled {
        -webkit-text-fill-color: #ffffff !important; /* Para navegadores basados en WebKit */
      }
      /* Asegurar que los inputs en general tengan un estilo oscuro */
      .form-control,
      .form-select {
        background-color: #2b2b2b;
        color: #ffffff;
        border: 1px solid #444444;
      }
      .form-control::placeholder {
        /* Estilo para el texto del placeholder */
        color: #aaaaaa;
      }

      /* INICIO MODIFICACI√ìN: Estilos para ocultar el scrollbar predeterminado del body */
      body.modal-open {
        overflow: hidden !important; /* Forzar ocultar el scrollbar del body cuando el modal est√° abierto */
      }

      /* Ocultar el scrollbar por defecto para navegadores Webkit (Chrome, Safari) */
      body.modal-open::-webkit-scrollbar,
      .modal-body::-webkit-scrollbar {
        /* Aplicado tambi√©n al modal-body */
        display: none;
        width: 0px; /* Para ocultarlo completamente */
        background: transparent; /* Hacer el scrollbar invisible */
      }

      /* Ocultar el scrollbar para Firefox */
      body.modal-open,
      .modal-body {
        /* Aplicado tambi√©n al modal-body */
        scrollbar-width: none; /* Firefox */
      }

      /* Ocultar el scrollbar para IE/Edge */
      body.modal-open,
      .modal-body {
        /* Aplicado tambi√©n al modal-body */
        -ms-overflow-style: none; /* IE y Edge */
      }
      /* FIN MODIFICACI√ìN: Estilos para ocultar el scrollbar predeterminado del body */
    </style>
  </head>
  <body>
    <!-- Contenido principal de la p√°gina -->
    <section class="welcome-contents">
      <!-- Elementos decorativos (elipses) -->
      <img
        src="/public/SVG/EllipseFigma.svg"
        class="welcome-elipce-1 welcome-elipce"
        alt="Elipse decorativa"
      />
      <img
        src="/public/SVG/EllipseFigma.svg"
        class="welcome-elipce-2 welcome-elipce"
        alt="Elipse decorativa"
      />

      <!-- Barra de navegaci√≥n (Header) -->
      <header class="navbar-gllr">
        <div class="container align-items-center">
          <div class="navbar-logo">
            <img src="/public/SVG/Logo-1.svg" alt="GLLR Logo" />
          </div>
          <div class="navbar-buttons">
            <!-- Botones de navegaci√≥n con nuevas clases para el degradado -->
            <button
              class="btn btn-nav-gradient-primary"
              data-bs-toggle="modal"
              data-bs-target="#loginModal"
              >Ingresar <i class="bx bx-right-arrow-alt"></i></button
            >
            <!-- El bot√≥n de registro ahora abre el registerModal (el nuevo formulario principal) -->
            <button
              class="btn btn-nav-gradient-secondary"
              data-bs-toggle="modal"
              data-bs-target="#registerModal"
              >Registrarse <i class="bx bx-right-arrow-alt"></i></button
            >
          </div>
        </div>
      </header>

      <!-- Contenido principal de la bienvenida (Hero Section) -->
      <div class="welcome-content-info">
        <div class="welcome-content-text">
          <h1 class="welcome-title">¬°Bienvenido/a a GLLR!</h1>
          <p class="welcome-content-sub-paragraph">
            Con GLLR, lleva un control detallado de tus calificaciones, organiza
            tus tareas y gestiona tus objetivos acad√©micos de forma sencilla y
            eficiente.
          </p>
        </div>
      </div>
      <!-- Imagen de fondo que se fusiona con el contenido -->
      <div class="welcome-background-image"></div>
    </section>

    <!-- Pie de p√°gina (Footer) -->
    <footer class="footer-gllr">
      <div class="container text-center">
        <div class="footer-logo">
          <img src="/public/SVG/Logo-1.svg" alt="GLLR Logo" />
        </div>
        <div class="footer-social-icons">
          <a href="#"><i class="bx bxl-facebook-square"></i></a>
          <a href="#"><i class="bx bxl-instagram"></i></a>
          <a href="#"><i class="bx bxl-linkedin-square"></i></a>
        </div>
        <p class="footer-copyright">
          &copy; 2025 Todos los derechos reservados
        </p>
      </div>
    </footer>

    <!-- Modal LOGIN -->
    <div
      class="modal fade"
      id="loginModal"
      tabindex="-1"
      aria-labelledby="loginModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body">
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Cerrar"></button>
            <img
              class="logo-login"
              src="/public/SVG/Logo-1.svg"
              alt="GLLR Logo"
            />
            <h5 class="modal-title" id="loginModalLabel">
              Bienvenido De Nuevo üëã
            </h5>
            <p class="login-modal-p">
              Inicia sesi√≥n para empezar la revisi√≥n de tus notas.
            </p>
            <form id="loginForm">
              <div class="mb-3">
                <label for="email" class="form-label">Correo Electr√≥nico</label>
                <input type="email" class="form-control" id="email" required />
              </div>
              <div class="mb-3">
                <label for="password" class="form-label">Contrase√±a</label>
                <input
                  type="password"
                  class="form-control"
                  id="password"
                  required
                />
              </div>
              <!-- Bot√≥n del modal de login con la clase personalizada -->
              <button type="submit" class="btn btn-primary-custom w-100"
                >Iniciar Sesi√≥n</button
              >
            </form>
            <div class="text-center mt-3">
              <!-- Enlace para "Recuperar Contrase√±a" -->
              <button class="btn btn-link" id="forgotPasswordBtn"
                >¬øOlvidaste tu contrase√±a?</button
              >
              <br />
              <!-- El bot√≥n de "Reg√≠strate aqu√≠" ahora abre el registerModal -->
              <button
                class="btn btn-link"
                data-bs-toggle="modal"
                data-bs-target="#registerModal"
                data-bs-dismiss="modal"
                id="openRegisterFromLoginBtn"
              >
                ¬øNo tienes cuenta? Reg√≠strate aqu√≠
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Nuevo Modal: Recuperar Contrase√±a - PASO 1 (Ingresar Correo) -->
    <div
      class="modal fade"
      id="forgotPasswordModal"
      tabindex="-1"
      aria-labelledby="forgotPasswordModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body">
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Cerrar"></button>
            <img
              class="logo-login"
              src="/public/SVG/Logo-1.svg"
              alt="GLLR Logo"
            />
            <h5 class="modal-title" id="forgotPasswordModalLabel">
              Recuperar Contrase√±a
            </h5>
            <p class="login-modal-p">
              Ingresa tu correo electr√≥nico para enviarte un c√≥digo de
              verificaci√≥n.
            </p>
            <form id="forgotPasswordForm">
              <div class="mb-3">
                <label for="recoveryEmail" class="form-label"
                  >Correo Electr√≥nico</label
                >
                <input
                  type="email"
                  class="form-control"
                  id="recoveryEmail"
                  required
                />
              </div>
              <button type="submit" class="btn btn-primary-custom w-100"
                >Enviar C√≥digo</button
              >
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Nuevo Modal: Recuperar Contrase√±a - PASO 2 (Verificar C√≥digo y Nueva Contrase√±a) -->
    <div
      class="modal fade"
      id="verifyCodeModal"
      tabindex="-1"
      aria-labelledby="verifyCodeModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body">
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Cerrar"></button>
            <img
              class="logo-login"
              src="/public/SVG/Logo-1.svg"
              alt="GLLR Logo"
            />
            <h5 class="modal-title" id="verifyCodeModalLabel">
              Verificaci√≥n y Nueva Contrase√±a
            </h5>
            <p class="login-modal-p">
              Ingresa el c√≥digo enviado a tu correo y tu nueva contrase√±a.
            </p>
            <form id="verifyCodeForm">
              <div class="mb-3">
                <label for="verificationCode" class="form-label"
                  >C√≥digo de Verificaci√≥n</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="verificationCode"
                  required
                  maxlength="6"
                />
              </div>
              <div class="mb-3">
                <label for="newPassword" class="form-label"
                  >Nueva Contrase√±a</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="newPassword"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="confirmNewPassword" class="form-label"
                  >Confirmar Nueva Contrase√±a</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="confirmNewPassword"
                  required
                />
              </div>
              <button type="submit" class="btn btn-primary-custom w-100"
                >Restablecer Contrase√±a</button
              >
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Nuevo Modal: Registro (registerModal) - ESTE ES EL FORMULARIO DE REGISTRO PRINCIPAL -->
    <div
      class="modal fade"
      id="registerModal"
      tabindex="-1"
      aria-labelledby="registerModalLabel"
      aria-hidden="true"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
    >
      <!-- MODIFICACI√ìN: A√ëADIDO data-bs-backdrop y data-bs-keyboard -->
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <!-- Cambiado a modal-lg para m√°s espacio -->
        <div class="modal-content">
          <div class="modal-body">
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Cerrar"></button>
            <img
              class="logo-login"
              src="/public/SVG/Logo-1.svg"
              alt="GLLR Logo"
            />
            <!-- Logo dentro del modal como en la imagen -->
            <h5 class="modal-title" id="registerModalLabel">Registro</h5>
            <!-- T√≠tulo "Registro" como en la imagen -->
            <p class="login-modal-p">Crea tu cuenta para acceder al sistema.</p>

            <form id="formRegistroPrincipal">
              <!-- Nuevo ID para el formulario principal de registro -->
              <!-- üîπ Informaci√≥n Personal -->
              <h6 class="section-title">Informaci√≥n Personal</h6>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="regCedula" class="form-label"
                    >C√©dula <span class="campo-obligatorio">*</span></label
                  >
                  <!-- Campo de c√©dula modificado para incluir maxlength -->
                  <input
                    type="tel"
                    class="form-control"
                    id="regCedula"
                    placeholder="Ejemplo: 123456789"
                    pattern="[0-9]{6,15}"
                    maxlength="15"
                    required
                  />
                  <div class="invalid-feedback"></div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="regPrimerNombre" class="form-label"
                    >Primer Nombre <span class="campo-obligatorio">*</span
                    ></label
                  >
                  <!-- MODIFICACI√ìN: pattern para solo letras y espacios -->
                  <input
                    type="text"
                    class="form-control"
                    id="regPrimerNombre"
                    placeholder="Tu Primer Nombre"
                    pattern="[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë√º√ú\s]+"
                    required
                  />
                  <div class="invalid-feedback"></div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="regSegundoNombre" class="form-label"
                    >Segundo Nombre</label
                  >
                  <!-- MODIFICACI√ìN: pattern para solo letras y espacios -->
                  <input
                    type="text"
                    class="form-control"
                    id="regSegundoNombre"
                    placeholder="Tu Segundo Nombre"
                    pattern="[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë√º√ú\s]*"
                  />
                  <div class="invalid-feedback"></div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="regPrimerApellido" class="form-label"
                    >Primer Apellido <span class="campo-obligatorio">*</span
                    ></label
                  >
                  <!-- MODIFICACI√ìN: pattern para solo letras y espacios -->
                  <input
                    type="text"
                    class="form-control"
                    id="regPrimerApellido"
                    placeholder="Tu Primer Apellido"
                    pattern="[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë√º√ú\s]+"
                    required
                  />
                  <div class="invalid-feedback"></div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="regSegundoApellido" class="form-label"
                    >Segundo Apellido</label
                  >
                  <!-- MODIFICACI√ìN: pattern para solo letras y espacios -->
                  <input
                    type="text"
                    class="form-control"
                    id="regSegundoApellido"
                    placeholder="Tu Segundo Apellido"
                    pattern="[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë√º√ú\s]*"
                  />
                  <div class="invalid-feedback"></div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="regTelefono" class="form-label"
                    >Tel√©fono <span class="campo-obligatorio">*</span></label
                  >
                  <div class="d-flex align-items-center gap-2">
                    <select
                      class="form-select codigo-area"
                      id="regCodigoArea"
                      style="width: 80px;"
                      required
                    >
                      <option value="0412">0412</option>
                      <option value="0422">0422</option>
                      <option value="0424">0424</option>
                      <option value="0414">0414</option>
                      <option value="0416">0416</option>
                      <option value="0426">0426</option>
                    </select>
                    <span class="separador-telefono">-</span>
                    <input
                      type="tel"
                      class="form-control numero-telefono"
                      id="regNumeroTelefono"
                      placeholder="1234567"
                      pattern="[0-9]{7}"
                      title="Debe contener 7 d√≠gitos"
                      required
                      style="flex-grow: 1;"
                    />
                    <div class="invalid-feedback"></div>
                  </div>
                </div>
              </div>

              <!-- üîπ Ubicaci√≥n -->
              <h6 class="section-title mt-4">Ubicaci√≥n</h6>
              <div class="row">
                <div class="col-md-12 mb-3">
                  <label for="regDireccion" class="form-label"
                    >Direcci√≥n <span class="campo-obligatorio">*</span></label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="regDireccion"
                    placeholder="Ingrese su direcci√≥n"
                    required
                  />
                  <div class="invalid-feedback"></div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="regEstado" class="form-label"
                    >Estado <span class="campo-obligatorio">*</span></label
                  >
                  <select class="form-select" id="regEstado" required>
                    <option value="" selected disabled
                      >Seleccione un estado</option
                    >
                  </select>
                  <div class="invalid-feedback"></div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="regCiudad" class="form-label"
                    >Ciudad <span class="campo-obligatorio">*</span></label
                  >
                  <select class="form-select" id="regCiudad" required disabled>
                    <option value="" selected disabled
                      >Primero seleccione un estado</option
                    >
                  </select>
                  <div class="invalid-feedback"></div>
                </div>
              </div>

              <!-- üîπ Credenciales del Usuario -->
              <h6 class="section-title mt-4">Credenciales del Usuario</h6>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="regEmail" class="form-label"
                    >Correo Electr√≥nico <span class="campo-obligatorio">*</span
                    ></label
                  >
                  <input
                    type="email"
                    class="form-control"
                    id="regEmail"
                    placeholder="ejemplo.venezuela@gmail.com"
                    required
                  />
                  <div class="invalid-feedback"></div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="regPassword" class="form-label"
                    >Contrase√±a <span class="campo-obligatorio">*</span></label
                  >
                  <div class="input-group">
                    <input
                      type="password"
                      class="form-control"
                      id="regPassword"
                      placeholder="Tu Contrase√±a"
                      required
                    />
                    <button
                      class="btn btn-outline-secondary toggle-password"
                      type="button"
                      data-target="regPassword"
                    >
                      <i class="bx bx-hide"></i>
                    </button>
                    <div class="invalid-feedback"></div>
                  </div>
                  <small id="passwordStrength" class="form-text text-muted"
                  ></small>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="regConfirmPassword" class="form-label"
                    >Confirmar contrase√±a <span class="campo-obligatorio"
                      >*</span
                    ></label
                  >
                  <div class="input-group">
                    <input
                      type="password"
                      class="form-control"
                      id="regConfirmPassword"
                      placeholder="Confirma tu Contrase√±a"
                      required
                    />
                    <button
                      class="btn btn-outline-secondary toggle-password"
                      type="button"
                      data-target="regConfirmPassword"
                    >
                      <i class="bx bx-hide"></i>
                    </button>
                    <div class="invalid-feedback"></div>
                  </div>
                </div>
              </div>

              <!-- üîπ Botones -->
              <div class="d-flex justify-content-between mt-4">
                <button
                  type="button"
                  class="btn btn-secondary-custom"
                  data-bs-dismiss="modal">Cancelar</button
                >
                <button
                  type="submit"
                  class="btn btn-primary-custom"
                  id="submitNewRegisterForm">Registrarse</button
                >
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para Alertas Personalizadas (Un solo modal para toda la aplicaci√≥n) -->
    <div
      class="modal fade"
      id="customAlertModal"
      tabindex="-1"
      aria-labelledby="customAlertModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content custom-alert-modal">
          <div class="modal-body text-center">
            <p class="mb-3" id="customAlertModalMessage"></p>
            <button
              type="button"
              class="btn btn-primary-custom"
              data-bs-dismiss="modal">Aceptar</button
            >
          </div>
        </div>
      </div>
    </div>

    <!-- Incluye Bootstrap JS (con Popper) -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"></script>

    <!-- Tu script JS para la l√≥gica de los modales y el backend -->
    <script type="module">
      // Variables globales (ajustadas para el nuevo flujo)
      const loginForm = document.getElementById("loginForm");
      const formRegistroPrincipal = document.getElementById(
        "formRegistroPrincipal"
      ); // ID para el formulario principal de registro

      // Elementos del nuevo formulario de registro
      const regCedulaInput = document.getElementById("regCedula");
      const regPrimerNombreInput = document.getElementById("regPrimerNombre");
      const regSegundoNombreInput = document.getElementById("regSegundoNombre");
      const regPrimerApellidoInput =
        document.getElementById("regPrimerApellido");
      const regSegundoApellidoInput =
        document.getElementById("regSegundoApellido");
      const regEmailInput = document.getElementById("regEmail");
      const regDireccionInput = document.getElementById("regDireccion");
      const regPasswordInput = document.getElementById("regPassword");
      const regConfirmPasswordInput =
        document.getElementById("regConfirmPassword");

      const regCodigoAreaSelect = document.getElementById("regCodigoArea");
      const regNumeroTelefonoInput =
        document.getElementById("regNumeroTelefono");
      const regEstadoSelect = document.getElementById("regEstado");
      const regCiudadSelect = document.getElementById("regCiudad");
      const submitNewRegisterFormBtn = document.getElementById(
        "submitNewRegisterForm"
      );
      const passwordStrengthFeedback =
        document.getElementById("passwordStrength");

      // Elementos para Recuperar Contrase√±a
      const forgotPasswordBtn = document.getElementById("forgotPasswordBtn");
      const forgotPasswordModal = new bootstrap.Modal(
        document.getElementById("forgotPasswordModal")
      );
      const forgotPasswordForm = document.getElementById("forgotPasswordForm");
      const recoveryEmailInput = document.getElementById("recoveryEmail");

      const verifyCodeModal = new bootstrap.Modal(
        document.getElementById("verifyCodeModal")
      );
      const verifyCodeForm = document.getElementById("verifyCodeForm");
      const verificationCodeInput = document.getElementById("verificationCode");
      const newPasswordInput = document.getElementById("newPassword");
      const confirmNewPasswordInput =
        document.getElementById("confirmNewPassword");

      let currentRecoveryEmail = ""; // Para almacenar el email del usuario durante el flujo de recuperaci√≥n

      // Referencia al modal de alerta personalizado fijo
      const customAlertModalElement =
        document.getElementById("customAlertModal");
      const customAlertModal = new bootstrap.Modal(customAlertModalElement);
      const customAlertModalMessage = document.getElementById(
        "customAlertModalMessage"
      );

      // üõ† Verificar sesi√≥n antes de acceder al dashboard
      document.addEventListener("DOMContentLoaded", async () => {
        // Asegura que todos los modales de Bootstrap est√©n ocultos y sus backdrops eliminados al cargar la p√°gina
        // Esto es crucial para evitar que la interfaz se quede "bloqueada" con un fondo oscuro si un modal
        // no se cerr√≥ correctamente en la navegaci√≥n o una redirecci√≥n.
        document.querySelectorAll(".modal.show").forEach((modalEl) => {
          const modalInstance = bootstrap.Modal.getInstance(modalEl);
          if (modalInstance) {
            modalInstance.hide();
          }
        });
        // Asegurarse de que cualquier backdrop persistente se elimine al cargar
        document.querySelectorAll(".modal-backdrop").forEach((backdropEl) => {
          backdropEl.remove();
        });

        try {
          // Se realiza una llamada al backend para verificar si el usuario est√° logueado.
          // Si la sesi√≥n no se borra correctamente en el backend al cerrar sesi√≥n,
          // esta verificaci√≥n podr√≠a detectar una sesi√≥n activa y redirigir
          // al usuario de vuelta al dashboard, creando un bucle.
          const response = await fetch("http://localhost:3001/usuario", {
            method: "GET",
            credentials: "include",
          });

          const data = await response.json();

          // Si hay un ID de usuario y la ruta actual es la p√°gina de bienvenida, redirige al dashboard.
          if (
            data.id &&
            (window.location.pathname === "/" ||
              window.location.pathname === "/welcome")
          ) {
            if (data.rol === "admin") {
              window.location.href = "/Admin-Control/Admin-home";
            } else if (data.rol === "estudiante") {
              window.location.href = "/Students-Control/Students-Control";
            } else if (data.rol === "profesor") {
              window.location.href = "/Profesor-Control/Profesor-Control";
            } else if (data.rol === "pendiente") {
              // Si el rol es 'pendiente', podr√≠a quedarse en la p√°gina de bienvenida
              // o ser redirigido a una p√°gina espec√≠fica para usuarios pendientes.
              // Aseg√∫rate de que esta l√≥gica no cause un bucle.
              // Actualmente, te deja en la p√°gina de bienvenida, lo cual es correcto si no hay redirecci√≥n.
              console.log(
                'Usuario con rol "pendiente" en la p√°gina de bienvenida.'
              );
            }
          }
        } catch (error) {
          console.error("‚ùå Error verificando sesi√≥n:", error);
          // Si hay un error al verificar la sesi√≥n (ej. el backend no responde o la sesi√≥n no existe),
          // el usuario permanecer√° en la p√°gina de bienvenida o ser√° redirigido al login.
          // Esto es el comportamiento deseado despu√©s de un logout exitoso.
        }
      });

      // L√≥gica de inicio de sesi√≥n
      loginForm.addEventListener("submit", async (event) => {
        event.preventDefault();

        const correoInput = document.getElementById("email");
        const contrasenaInput = document.getElementById("password");

        if (!correoInput || !contrasenaInput) {
          console.error(
            "‚ùå Error: No se encontraron los campos de correo o contrase√±a."
          );
          showCustomAlert(
            "Error: No se encontraron los campos de correo o contrase√±a."
          );
          return;
        }

        const correo = correoInput.value.trim();
        const contrasena = contrasenaInput.value.trim();

        if (!correo || !contrasena) {
          showCustomAlert("Todos los campos son obligatorios.");
          return;
        }

        try {
          const response = await fetch("http://localhost:3001/login", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ correo, contrase√±a: contrasena }),
          });

          const data = await response.json();

          if (response.ok) {
            if (data.rol === "pendiente") {
              showCustomAlert(
                "Tu cuenta est√° pendiente de aprobaci√≥n. Por favor, espera a que un administrador la apruebe."
              );
            } else {
              showCustomAlert("Inicio de sesi√≥n exitoso.", () => {
                localStorage.setItem("currentUserId", data.id); // 'data.id' es el ID de usuario devuelto por tu backend
                setTimeout(() => {
                  if (data.rol === "admin") {
                    window.location.href = "/Admin-Control/Admin-home";
                  } else if (data.rol === "estudiante") {
                    window.location.href = "/Students-Control/Students-Control";
                  } else if (data.rol === "profesor") {
                    window.location.href = "/Profesor-Control/Profesor-Control";
                  }
                }, 200);
              });
            }
          } else {
            showCustomAlert(data.error);
          }
        } catch (error) {
          showCustomAlert("Error de conexi√≥n al servidor.");
          console.error(error);
        }
      });

      // L√≥gica del nuevo formulario de registro principal (registerModal)
      // Cargar datos al abrir el modal de registro
      document
        .getElementById("registerModal")
        .addEventListener("shown.bs.modal", function () {
          cargarEstados();
          // Limpiar el formulario al abrirlo
          formRegistroPrincipal.reset();
          limpiarTodosLosErrores(formRegistroPrincipal);
          regCiudadSelect.innerHTML =
            '<option value="" selected disabled>Primero seleccione un estado</option>';
          regCiudadSelect.disabled = true;
          passwordStrengthFeedback.textContent = ""; // Limpiar mensaje de fortaleza de contrase√±a

          // MODIFICACI√ìN: Limpiar y revalidar campos de nombre/apellido al abrir
          regPrimerNombreInput.value = "";
          limpiarError(regPrimerNombreInput);
          regSegundoNombreInput.value = "";
          limpiarError(regSegundoNombreInput);
          regPrimerApellidoInput.value = "";
          limpiarError(regPrimerApellidoInput);
          regSegundoApellidoInput.value = "";
          limpiarError(regSegundoApellidoInput);
        });

      // MODIFICACI√ìN: Manejar el clic en el bot√≥n "¬øNo tienes cuenta? Reg√≠strate aqu√≠" en el modal de login
      document
        .getElementById("openRegisterFromLoginBtn")
        .addEventListener("click", function (event) {
          // Ocultar expl√≠citamente el modal de login antes de mostrar el modal de registro
          const loginModalInstance = bootstrap.Modal.getInstance(
            document.getElementById("loginModal")
          );
          if (loginModalInstance) {
            loginModalInstance.hide();
          }
          // Los atributos data-bs-toggle y data-bs-target se encargar√°n de mostrar el registerModal
          // despu√©s de que este event listener se complete.
        });

      // L√≥gica para Recuperar Contrase√±a
      forgotPasswordBtn.addEventListener("click", () => {
        // Ocultar modal de login y mostrar modal de recuperar contrase√±a
        const loginModalInstance = bootstrap.Modal.getInstance(
          document.getElementById("loginModal")
        );
        if (loginModalInstance) {
          loginModalInstance.hide();
        }
        forgotPasswordModal.show();
        forgotPasswordForm.reset(); // Limpiar el formulario al abrir
        limpiarTodosLosErrores(forgotPasswordForm);
      });

      // Enviar c√≥digo de recuperaci√≥n
      forgotPasswordForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const email = recoveryEmailInput.value.trim();

        if (!email) {
          showCustomAlert("Por favor, ingresa tu correo electr√≥nico.");
          return;
        }

        try {
          // Llama al backend para solicitar el c√≥digo
          const response = await fetch(
            "http://localhost:3001/solicitar-codigo-recuperacion",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ correo: email }),
            }
          );

          const data = await response.json();

          if (response.ok) {
            currentRecoveryEmail = email; // Guarda el email para el siguiente paso
            showCustomAlert(
              "C√≥digo enviado exitosamente a tu correo electr√≥nico.",
              () => {
                forgotPasswordModal.hide();
                verifyCodeModal.show(); // Abre el modal de verificaci√≥n
                verifyCodeForm.reset(); // Limpiar formulario
                limpiarTodosLosErrores(verifyCodeForm);
              }
            );
          } else {
            showCustomAlert(
              data.error ||
                "Error al enviar el c√≥digo de recuperaci√≥n. Intenta de nuevo."
            );
          }
        } catch (error) {
          console.error("Error al solicitar c√≥digo:", error);
          showCustomAlert(
            "Error de conexi√≥n al servidor al solicitar el c√≥digo."
          );
        }
      });

      // Verificar c√≥digo y restablecer contrase√±a
      verifyCodeForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const codigo = verificationCodeInput.value.trim();
        const newPassword = newPasswordInput.value.trim();
        const confirmNewPassword = confirmNewPasswordInput.value.trim();

        if (!codigo || !newPassword || !confirmNewPassword) {
          showCustomAlert("Todos los campos son obligatorios.");
          return;
        }

        if (newPassword !== confirmNewPassword) {
          showCustomAlert("Las contrase√±as no coinciden.");
          return;
        }

        // Aqu√≠ puedes a√±adir validaci√≥n de fortaleza de la nueva contrase√±a si lo deseas
        if (newPassword.length < 8) {
          // Ejemplo de validaci√≥n simple
          showCustomAlert(
            "La nueva contrase√±a debe tener al menos 8 caracteres."
          );
          return;
        }

        try {
          // Llama al backend para verificar el c√≥digo y actualizar la contrase√±a
          const response = await fetch(
            "http://localhost:3001/restablecer-contrasena",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                correo: currentRecoveryEmail,
                codigo,
                nuevaContrasena: newPassword,
              }),
            }
          );

          const data = await response.json();

          if (response.ok) {
            showCustomAlert(
              "Contrase√±a restablecida exitosamente. Ahora puedes iniciar sesi√≥n con tu nueva contrase√±a.",
              () => {
                verifyCodeModal.hide();
                // Opcional: Abrir el modal de login de nuevo
                new bootstrap.Modal(
                  document.getElementById("loginModal")
                ).show();
              }
            );
          } else {
            showCustomAlert(
              data.error ||
                "Error al restablecer la contrase√±a. Verifica el c√≥digo."
            );
          }
        } catch (error) {
          console.error("Error al restablecer contrase√±a:", error);
          showCustomAlert(
            "Error de conexi√≥n al servidor al restablecer la contrase√±a."
          );
        }
      });

      // Funci√≥n para cargar estados
      async function cargarEstados() {
        regEstadoSelect.disabled = true;
        regEstadoSelect.innerHTML =
          '<option value="" selected disabled>Cargando estados...</option>';

        try {
          const response = await fetch("http://localhost:3001/api/estados");
          if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);

          const estados = await response.json();

          regEstadoSelect.innerHTML =
            '<option value="" selected disabled>Seleccione un estado</option>';
          estados.forEach((estado) => {
            const option = document.createElement("option");
            option.value = estado.id_estado;
            option.textContent = estado.estados;
            regEstadoSelect.appendChild(option);
          });

          regEstadoSelect.disabled = false;
        } catch (error) {
          console.error("Error cargando estados:", error);
          regEstadoSelect.innerHTML =
            '<option value="" selected disabled>Error al cargar estados</option>';
          showCustomAlert(
            "Error al cargar estados. Intente recargar la p√°gina."
          );
        }
      }

      // Event listeners para los selects
      regEstadoSelect.addEventListener("change", async function () {
        const estadoId = this.value;
        regCiudadSelect.innerHTML =
          '<option value="" selected disabled>Cargando ciudades...</option>';
        regCiudadSelect.disabled = true;

        if (!estadoId) return;

        try {
          const response = await fetch(
            `http://localhost:3001/api/estados/${estadoId}/ciudades`
          );
          if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);

          const ciudades = await response.json();

          regCiudadSelect.innerHTML =
            '<option value="" selected disabled>Seleccione una ciudad</option>';
          ciudades.forEach((ciudad) => {
            const option = document.createElement("option");
            option.value = ciudad.id_ciudad;
            option.textContent = ciudad.ciudad;
            regCiudadSelect.appendChild(option);
          });

          regCiudadSelect.disabled = false;
        } catch (error) {
          console.error("Error cargando ciudades:", error);
          regCiudadSelect.innerHTML =
            '<option value="" selected disabled>Error al cargar ciudades</option>';
          showCustomAlert("Error al cargar ciudades. Intente nuevamente.");
        }
      });

      // Validar c√©dula al cambiar el input y al perder el foco
      regCedulaInput.addEventListener("input", function () {
        // Esta l√≠nea asegura que solo se permitan d√≠gitos y recorta el valor a 15 caracteres
        this.value = this.value.replace(/\D/g, "").slice(0, 15);
        const cedula = this.value.trim();
        // Nueva validaci√≥n de formato de c√©dula venezolana (6 a 15 d√≠gitos num√©ricos)
        const cedulaRegex = /^\d{6,15}$/;
        if (!cedulaRegex.test(cedula)) {
          mostrarError(
            regCedulaInput,
            "Formato de c√©dula inv√°lido (6-15 d√≠gitos num√©ricos)."
          );
        } else {
          limpiarError(regCedulaInput);
        }
      });

      regCedulaInput.addEventListener("blur", async function () {
        const cedula = this.value.trim();
        if (!cedula) {
          mostrarError(regCedulaInput, "La c√©dula es obligatoria.");
          return;
        }
        // Nueva validaci√≥n de formato de c√©dula venezolana (6 a 15 d√≠gitos num√©ricos)
        const cedulaRegex = /^\d{6,15}$/;
        if (!cedulaRegex.test(cedula)) {
          mostrarError(
            regCedulaInput,
            "Formato de c√©dula inv√°lido (6-15 d√≠gitos num√©ricos)."
          );
          return;
        }

        try {
          const response = await fetch(
            `http://localhost:3001/api/verificar-cedula?cedula=${encodeURIComponent(cedula)}`
          );
          if (!response.ok) {
            // Si la respuesta no es OK, podr√≠a ser un 409 Conflict o similar
            const errorData = await response.json();
            if (response.status === 409 && errorData.existe) {
              // Asumiendo que 409 indica conflicto de existencia
              mostrarError(
                regCedulaInput,
                "Esta c√©dula ya est√° registrada en el sistema."
              );
              return; // Detener la ejecuci√≥n si la c√©dula ya existe
            }
            throw new Error(
              `Error HTTP: ${response.status} - ${errorData.message || "Error desconocido"}`
            );
          }

          const data = await response.json();
          if (data.existe) {
            // Asume que tu backend devuelve { existe: true/false }
            mostrarError(
              regCedulaInput,
              "Esta c√©dula ya est√° registrada en el sistema."
            );
          } else {
            limpiarError(regCedulaInput);
          }
        } catch (error) {
          console.error("Error verificando c√©dula:", error);
          // Si el error es una instancia de Error, usa su mensaje, de lo contrario, un mensaje gen√©rico.
          mostrarError(
            regCedulaInput,
            error.message || "Error al verificar la c√©dula."
          );
        }
      });

      // MODIFICACI√ìN: Funci√≥n de validaci√≥n de solo letras
      function validateTextOnly(inputElement, fieldName) {
        const value = inputElement.value;
        // Regex para letras (may√∫sculas, min√∫sculas, acentuadas) y espacios, NO permitiendo n√∫meros.
        const regex = /^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë√º√ú\s]*$/;

        if (!regex.test(value)) {
          // Si el valor contiene caracteres no permitidos (ej. n√∫meros), eliminarlos inmediatamente.
          inputElement.value = value.replace(/[^a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë√º√ú\s]/g, "");
          mostrarError(
            inputElement,
            `El campo ${fieldName} solo permite letras y espacios.`
          );
          return false;
        } else if (
          inputElement.hasAttribute("required") &&
          value.trim() === ""
        ) {
          // Esta parte asegura que los campos requeridos no sean solo espacios
          mostrarError(inputElement, `El campo ${fieldName} es obligatorio.`);
          return false;
        } else {
          limpiarError(inputElement);
          return true;
        }
      }

      // MODIFICACI√ìN: A√±adir event listeners para validaci√≥n de nombres y apellidos
      regPrimerNombreInput.addEventListener("input", () => {
        regPrimerNombreInput.value = regPrimerNombreInput.value.replace(
          /[^a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë√º√ú\s]/g,
          ""
        ); // Filtrar n√∫meros inmediatamente
        validateTextOnly(regPrimerNombreInput, "Primer Nombre");
      });
      regSegundoNombreInput.addEventListener("input", () => {
        regSegundoNombreInput.value = regSegundoNombreInput.value.replace(
          /[^a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë√º√ú\s]/g,
          ""
        ); // Filtrar n√∫meros inmediatamente
        validateTextOnly(regSegundoNombreInput, "Segundo Nombre");
      });
      regPrimerApellidoInput.addEventListener("input", () => {
        regPrimerApellidoInput.value = regPrimerApellidoInput.value.replace(
          /[^a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë√º√ú\s]/g,
          ""
        ); // Filtrar n√∫meros inmediatamente
        validateTextOnly(regPrimerApellidoInput, "Primer Apellido");
      });
      regSegundoApellidoInput.addEventListener("input", () => {
        regSegundoApellidoInput.value = regSegundoApellidoInput.value.replace(
          /[^a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë√º√ú\s]/g,
          ""
        ); // Filtrar n√∫meros inmediatamente
        validateTextOnly(regSegundoApellidoInput, "Segundo Apellido");
      });

      // Validar n√∫mero de tel√©fono
      regNumeroTelefonoInput.addEventListener("input", function () {
        this.value = this.value.replace(/\D/g, "").slice(0, 7);
        if (this.value.length !== 7) {
          mostrarError(this, "Debe contener 7 d√≠gitos.");
        } else {
          limpiarError(this);
        }
      });

      // Toggle Password Visibility
      document.querySelectorAll(".toggle-password").forEach((button) => {
        button.addEventListener("click", function () {
          const targetId = this.dataset.target;
          const passwordInput = document.getElementById(targetId);
          const icon = this.querySelector("i");

          if (passwordInput.type === "password") {
            passwordInput.type = "text";
            icon.classList.remove("bx-hide");
            icon.classList.add("bx-show");
          } else {
            passwordInput.type = "password";
            icon.classList.remove("bx-show");
            icon.classList.add("bx-hide");
          }
        });
      });

      // Password Strength Validation
      regPasswordInput.addEventListener("input", function () {
        const password = this.value;
        let strength = 0;
        let feedback = [];

        if (password.length >= 8) {
          strength += 1;
        } else {
          feedback.push("Al menos 8 caracteres.");
        }
        if (/[A-Z]/.test(password)) {
          strength += 1;
        } else {
          feedback.push("Una letra may√∫scula.");
        }
        if (/[a-z]/.test(password)) {
          strength += 1;
        } else {
          feedback.push("Una letra min√∫scula.");
        }
        if (/[0-9]/.test(password)) {
          strength += 1;
        } else {
          feedback.push("Un n√∫mero.");
        }
        if (/[^A-Za-z0-9]/.test(password)) {
          strength += 1;
        } else {
          feedback.push("Un caracter especial.");
        }

        if (password.length === 0) {
          passwordStrengthFeedback.textContent = "";
          limpiarError(regPasswordInput);
          return;
        }

        let strengthText = "";
        let color = "";

        if (strength === 5) {
          strengthText = "¬°Excelente!";
          color = "green";
          limpiarError(regPasswordInput);
        } else if (strength >= 3) {
          strengthText = "Buena";
          color = "orange";
          limpiarError(regPasswordInput);
        } else {
          strengthText = "D√©bil";
          color = "red";
          mostrarError(
            regPasswordInput,
            "Contrase√±a d√©bil: " + feedback.join(", ")
          );
        }
        passwordStrengthFeedback.textContent = `Fortaleza: ${strengthText}`;
        passwordStrengthFeedback.style.color = color;
      });

      // Validar coincidencia de contrase√±as
      regConfirmPasswordInput.addEventListener("input", function () {
        // Cambiado a 'input' para feedback m√°s r√°pido
        if (regPasswordInput.value !== regConfirmPasswordInput.value) {
          mostrarError(
            regConfirmPasswordInput,
            "Las contrase√±as no coinciden."
          );
        } else {
          limpiarError(regConfirmPasswordInput);
        }
      });
      regPasswordInput.addEventListener("input", function () {
        // A√±adido para que se revalide al cambiar la primera
        if (regConfirmPasswordInput.value !== "") {
          // Solo revalida si ya hay algo en confirmar
          if (regPasswordInput.value !== regConfirmPasswordInput.value) {
            mostrarError(
              regConfirmPasswordInput,
              "Las contrase√±as no coinciden."
            );
          } else {
            limpiarError(regConfirmPasswordInput);
          }
        }
      });

      // Validaci√≥n de unicidad de correo electr√≥nico (Frontend con llamada a la API del Backend)
      regEmailInput.addEventListener("blur", async function () {
        const email = this.value.trim();
        if (!email) {
          mostrarError(regEmailInput, "El correo electr√≥nico es obligatorio.");
          return;
        }

        try {
          const response = await fetch(
            `http://localhost:3001/api/verificar-correo?email=${encodeURIComponent(email)}`
          );
          if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);

          const data = await response.json();

          if (data.existe) {
            mostrarError(
              regEmailInput,
              "Este correo electr√≥nico ya est√° registrado."
            );
          } else {
            limpiarError(regEmailInput);
          }
        } catch (error) {
          console.error("Error al verificar el correo electr√≥nico:", error);
          mostrarError(
            regEmailInput,
            "Error al verificar el correo electr√≥nico. Intente de nuevo."
          );
        }
      });

      // L√≥gica para limpiar el formulario al hacer clic en "Cancelar"
      formRegistroPrincipal
        .querySelector('button[type="button"][data-bs-dismiss="modal"]')
        .addEventListener("click", function () {
          formRegistroPrincipal.reset();
          limpiarTodosLosErrores(formRegistroPrincipal);
          regCiudadSelect.innerHTML =
            '<option value="" selected disabled>Primero seleccione un estado</option>';
          regCiudadSelect.disabled = true;
          passwordStrengthFeedback.textContent = ""; // Limpiar mensaje de fortaleza de contrase√±a
        });

      // Manejar env√≠o del formulario principal de registro
      formRegistroPrincipal.addEventListener("submit", async function (e) {
        e.preventDefault();

        // Validar campos obligatorios y reglas de contrase√±a
        const camposRequeridos = [
          { input: regCedulaInput, nombre: "C√©dula" },
          { input: regPrimerNombreInput, nombre: "Primer Nombre" },
          { input: regPrimerApellidoInput, nombre: "Primer Apellido" },
          { input: regEmailInput, nombre: "Correo Electr√≥nico" },
          { input: regDireccionInput, nombre: "Direcci√≥n" },
          { input: regPasswordInput, nombre: "Contrase√±a" },
          { input: regConfirmPasswordInput, nombre: "Confirmar contrase√±a" },
          { input: regNumeroTelefonoInput, nombre: "Tel√©fono" },
          { input: regEstadoSelect, nombre: "Estado" },
          { input: regCiudadSelect, nombre: "Ciudad" },
        ];

        let formularioValido = true;

        camposRequeridos.forEach((campo) => {
          // Revalidar campos obligatorios
          if (
            !campo.input.value ||
            (campo.input.tagName === "SELECT" && campo.input.value === "")
          ) {
            mostrarError(
              campo.input,
              `El campo ${campo.nombre} es obligatorio.`
            );
            formularioValido = false;
          } else {
            limpiarError(campo.input);
          }
        });

        // Revalidaciones adicionales
        // Validaci√≥n de formato de c√©dula (6 a 15 d√≠gitos num√©ricos)
        const cedulaRegex = /^\d{6,15}$/;
        if (!cedulaRegex.test(regCedulaInput.value.trim())) {
          mostrarError(
            regCedulaInput,
            "Formato de c√©dula inv√°lido (6-15 d√≠gitos num√©ricos)."
          );
          formularioValido = false;
        }

        if (regPasswordInput.value !== regConfirmPasswordInput.value) {
          mostrarError(
            regConfirmPasswordInput,
            "Las contrase√±as no coinciden."
          );
          formularioValido = false;
        }
        if (regNumeroTelefonoInput.value.length !== 7) {
          mostrarError(
            regNumeroTelefonoInput,
            "El tel√©fono debe contener 7 d√≠gitos."
          );
          formularioValido = false;
        }
        // MODIFICACI√ìN: Revalidar campos de nombre/apellido
        if (!validateTextOnly(regPrimerNombreInput, "Primer Nombre"))
          formularioValido = false;
        if (!validateTextOnly(regSegundoNombreInput, "Segundo Nombre"))
          formularioValido = false;
        if (!validateTextOnly(regPrimerApellidoInput, "Primer Apellido"))
          formularioValido = false;
        if (!validateTextOnly(regSegundoApellidoInput, "Segundo Apellido"))
          formularioValido = false;

        // Forzar revalidaci√≥n de fortaleza de contrase√±a y email
        regPasswordInput.dispatchEvent(new Event("input"));
        regEmailInput.dispatchEvent(new Event("blur"));
        regCedulaInput.dispatchEvent(new Event("blur")); // Forzar revalidaci√≥n de c√©dula

        // Si hay alg√∫n error visible, el formulario no es v√°lido
        if (formRegistroPrincipal.querySelector(".is-invalid")) {
          formularioValido = false;
        }

        if (!formularioValido) {
          showCustomAlert(
            "Por favor, complete todos los campos obligatorios y corrija los errores."
          );
          return;
        }

        // Mostrar loading en el bot√≥n
        submitNewRegisterFormBtn.disabled = true;
        submitNewRegisterFormBtn.innerHTML = `
              <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              Registrando...
            `;

        try {
          // Obtener valores del formulario
          const formData = {
            cedula: regCedulaInput.value.trim(),
            primerNombre: regPrimerNombreInput.value.trim(),
            segundoNombre: regSegundoNombreInput.value.trim(),
            primerApellido: regPrimerApellidoInput.value.trim(),
            segundoApellido: regSegundoApellidoInput.value.trim(),
            correo: regEmailInput.value.trim(), // Usar 'correo' para el backend
            telefono: `${regCodigoAreaSelect.value}-${regNumeroTelefonoInput.value}`,
            direccion: regDireccionInput.value.trim(),
            id_estado: regEstadoSelect.value,
            id_ciudad: regCiudadSelect.value,
            contrase√±a: regPasswordInput.value.trim(), // Usar 'contrase√±a' para el backen
          };

          // Enviar datos al servidor
          const response = await fetch("http://localhost:3001/register", {
            // Ajusta el endpoint si es necesario
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(formData),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || "Error al registrar el usuario.");
          }

          // Mostrar mensaje de √©xito y redirigir o abrir modal de login
          showCustomAlert(
            "Usuario registrado exitosamente. Espera aprobaci√≥n del administrador.",
            () => {
              // Cerrar expl√≠citamente el modal de registro si sigue abierto
              const registerModal = bootstrap.Modal.getInstance(
                document.getElementById("registerModal")
              );
              if (registerModal) {
                registerModal.hide();
              }
              new bootstrap.Modal(document.getElementById("loginModal")).show(); // Abrir modal de login
            }
          );
        } catch (error) {
          console.error("Error en el registro:", error);
          showCustomAlert(error.message);
        } finally {
          // Restaurar bot√≥n
          submitNewRegisterFormBtn.disabled = false;
          submitNewRegisterFormBtn.textContent = "Registrarse";
        }
      });

      // Funciones auxiliares para errores y alertas (adaptadas)
      function mostrarError(elemento, mensaje) {
        elemento.classList.add("is-invalid");
        // Busca el feedback de invalidez directamente despu√©s del elemento o dentro de su padre
        const errorElement = elemento.nextElementSibling;
        if (
          errorElement &&
          errorElement.classList.contains("invalid-feedback")
        ) {
          errorElement.textContent = mensaje;
          errorElement.style.display = "block";
        } else {
          const parentErrorElement =
            elemento.parentNode.querySelector(".invalid-feedback");
          if (parentErrorElement) {
            parentErrorElement.textContent = mensaje;
            parentErrorElement.style.display = "block";
          }
        }
      }

      function limpiarError(elemento) {
        elemento.classList.remove("is-invalid");
        const errorElement = elemento.nextElementSibling;
        if (
          errorElement &&
          errorElement.classList.contains("invalid-feedback")
        ) {
          errorElement.textContent = "";
          errorElement.style.display = "none";
        } else {
          const parentErrorElement =
            elemento.parentNode.querySelector(".invalid-feedback");
          if (parentErrorElement) {
            parentErrorElement.textContent = "";
            parentErrorElement.style.display = "none";
          }
        }
      }

      function limpiarTodosLosErrores(form) {
        form
          .querySelectorAll(".is-invalid")
          .forEach((el) => el.classList.remove("is-invalid"));
        form.querySelectorAll(".invalid-feedback").forEach((el) => {
          el.textContent = "";
          el.style.display = "none";
        });
      }

      // MODIFICACI√ìN: Funci√≥n showCustomAlert utiliza un modal preexistente
      function showCustomAlert(message, callback = () => {}) {
        customAlertModalMessage.textContent = message;
        customAlertModal.show();

        // Eliminar listeners previos para evitar m√∫ltiples ejecuciones
        customAlertModalElement.removeEventListener(
          "hidden.bs.modal",
          customAlertModalElement._currentCallback
        );

        // Guardar y a√±adir el nuevo callback
        customAlertModalElement._currentCallback = () => {
          callback();
          // Limpiar el callback despu√©s de su ejecuci√≥n para evitar su llamada en futuras aperturas no relacionadas
          customAlertModalElement._currentCallback = null;
        };
        customAlertModalElement.addEventListener(
          "hidden.bs.modal",
          customAlertModalElement._currentCallback
        );
      }

      // --- INSTRUCCIONES PARA EL MANEJO DE CERRAR SESI√ìN EN EL DASHBOARD ---
      // El problema de un bucle o pantalla bloqueada despu√©s de "salir" se debe
      // com√∫nmente a que el backend no invalida la sesi√≥n correctamente,
      // o la redirecci√≥n del frontend no es robusta.

      // Aqu√≠ se muestra un ejemplo de c√≥mo deber√≠a funcionar una funci√≥n de logout
      // que deber√≠a ser llamada desde el bot√≥n "Salir" en tus p√°ginas del dashboard.
      async function handleLogout() {
        try {
          // 1. Realizar una llamada al backend para destruir la sesi√≥n.
          // Aseg√∫rate de que tu endpoint de logout en Node.js invalide
          // cualquier cookie de sesi√≥n o token de autenticaci√≥n.
          const response = await fetch("http://localhost:3001/logout", {
            // Ajusta la URL de tu endpoint de logout
            method: "POST", // O 'GET' dependiendo de c√≥mo lo tengas configurado en tu backend
            credentials: "include", // Para enviar cookies de sesi√≥n si las usas
          });

          if (!response.ok) {
            // Si el backend responde con un error, mu√©stralo.
            const errorData = await response.json();
            throw new Error(
              errorData.error || "Error al cerrar sesi√≥n en el servidor."
            );
          }

          // 2. Si el logout es exitoso en el backend, redirige al usuario a la p√°gina de bienvenida.
          // Esta redirecci√≥n forzar√° la recarga de la p√°gina de bienvenida, y el script
          // de DOMContentLoaded verificar√° la sesi√≥n limpia (sin data.id) y no redirigir√° de nuevo.
          window.location.href = "/welcome"; // O '/', la ruta de tu p√°gina de bienvenida
        } catch (error) {
          console.error("‚ùå Error al cerrar sesi√≥n:", error);
          showCustomAlert(
            error.message ||
              "Error al cerrar sesi√≥n. Por favor, int√©ntelo de nuevo."
          );
        }
      }

      // EJEMPLO: Si tuvieras un bot√≥n de logout en una de tus p√°ginas de dashboard,
      // su evento 'click' deber√≠a llamar a handleLogout.
      // Por ejemplo (en una p√°gina de dashboard, no en welcome.html):
      // const logoutButton = document.getElementById('logoutButton');
      // if (logoutButton) {
      //     logoutButton.addEventListener('click', handleLogout);
      // }
      // --- FIN DE INSTRUCCIONES PARA EL MANEJO DE CERRAR SESI√ìN EN EL DASHBOARD ---\

      // --- SOLUCI√ìN: Limpiar backdrop y clase modal-open al cerrar los modales de recuperaci√≥n ---
      ["forgotPasswordModal", "verifyCodeModal"].forEach((modalId) => {
        const modalEl = document.getElementById(modalId);
        if (modalEl) {
          modalEl.addEventListener("hidden.bs.modal", () => {
            // Elimina cualquier backdrop persistente
            document.querySelectorAll(".modal-backdrop").forEach((el) => el.remove());
            // Elimina la clase modal-open del body si qued√≥ pegada
            document.body.classList.remove("modal-open");
            // Restaura el scroll si qued√≥ bloqueado
            document.body.style.overflow = "";
          });
        }
      });
    </script>
  </body>
</html>
